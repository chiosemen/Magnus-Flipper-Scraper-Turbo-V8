# Repo Boundaries (Magnus Flipper)

## 1) High-level philosophy
- Phase-locked execution: Only one phase is active at a time. No cross-phase edits.
- One Ralph Loop = one domain: each loop touches a single bounded area and exits clean.

## 2) Explicit domain boundaries

### /packages/*
- Purpose: shared, pure modules with no runtime side effects.
- Allowed: schemas, policy models, pricing rules, telemetry logic, adapters.
- Never: app-specific business logic, UI code, worker execution, API routes.

### /api
- Purpose: authenticated backend orchestration and request handling.
- Allowed: routes, auth gates, tier enforcement, job creation, Stripe webhooks, database access.
- Never: scraping logic, UI rendering, browser automation.

### /workers
- Purpose: scraping and job execution only.
- Allowed: marketplace scrapers, parsing, antibot signals, persistence writes.
- Never: billing logic, Stripe, UI concerns, user management.

### /apps/web
- Purpose: UI only.
- Allowed: rendering, user interactions, calling API endpoints.
- Never: business logic, scraping, enforcement math, database access.

### /docs
- Purpose: design truth source.
- Allowed: decisions, runbooks, policies, constraints.
- Never: executable logic or configuration truth.

## 3) DO NOT TOUCH rules
- CI files (e.g., `.github/workflows/*`) unless explicitly authorized.
- `package.json` (root or workspace) and `pnpm-lock.yaml` unless explicitly authorized.
- Billing/Economics/Telemetry packages unless explicitly authorized.
- Shared schemas (`/packages/types`, `/packages/database`) unless explicitly authorized.

## 4) Allowed cross-domain dependencies
- /api -> /packages/*
- /workers -> /packages/*
- /apps/web -> /packages/types (types only)
- /docs -> none (documentation only)

Forbidden examples:
- /workers -> /api
- /apps/web -> /workers
- /apps/web -> /api internals (only public API contracts)

## 5) Stash & recovery protocol
- Stash when: switching loops, changing scopes, or after partial validation.
- Re-apply only after: confirming clean working tree and matching loop scope.
- Avoid corkscrew commits:
  - Never stack unrelated changes in one commit.
  - Never mix docs, infra, and runtime changes in one PR.

## 6) Example Ralph Loop checklist

### Before starting
- Confirm active phase and scope.
- `git status -sb` is clean or explicitly stashed.
- Identify exact files to touch.

### During execution
- Touch only the allowed paths.
- Stop immediately on constraint violations.
- Validate only the scope-specific tests.

### Before commit
- Ensure diff matches the loop scope only.
- Run required validations.
- Commit with a single, scope-accurate message.
